C51 COMPILER V9.60.7.0   NTC                                                               06/26/2024 11:53:05 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE NTC
OBJECT MODULE PLACED IN .\Objects\ntc.obj
COMPILER INVOKED BY: D:\AppData\Keil_v5\C51\BIN\C51.EXE ntc.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listin
                    -gs\ntc.lst) TABS(2) OBJECT(.\Objects\ntc.obj)

line level    source

   1          #include "ntc.h"
   2          #include "ADC.h"
   3          #include "GPIO.h"
   4          #include "NVIC.h"
   5          
   6          
   7          #define R20 10
   8          
   9          #define ABS(x) x > 0 ? (x) : -(x)
  10          
  11          /* 加上Static,可以保证该函数只能在当前.c文件内使用，可以避免函数名冲突 */
  12          static void gpio_config(void) {
  13   1      
  14   1        /* 初始化ADC引脚 -- GPIO P04 为浮空输入模式 */
  15   1        GPIO_InitTypeDef gpio_config_struct;
  16   1        gpio_config_struct.Mode = GPIO_HighZ;  // 浮空输入
  17   1        gpio_config_struct.Pin = NTC_GPIO_PIN; // 引脚4
  18   1        GPIO_Inilize(NTC_GPIO, &gpio_config_struct);
  19   1      }
  20          
  21          void ntc_config(void) {
  22   1        /* 初始化ADC配置 */
  23   1        ADC_InitTypeDef ADC_InitStructure; // 结构定义
  24   1      
  25   1        ADC_InitStructure.ADC_SMPduty = 31; // ADC 模拟信号采样时间控制, 0~31（注意：
  26   1                                            // SMPDUTY 一定不能设置小于 10）
  27   1        ADC_InitStructure.ADC_CsSetup = 0; // ADC 通道选择时间控制 0(默认),1
  28   1        ADC_InitStructure.ADC_CsHold = 1; // ADC 通道选择保持时间控制 0,1(默认),2,3
  29   1        ADC_InitStructure.ADC_Speed =
  30   1            ADC_SPEED_2X1T; // 设置 ADC 工作时钟频率  ADC_SPEED_2X1T~ADC_SPEED_2X16T
  31   1        ADC_InitStructure.ADC_AdjResult =
  32   1            ADC_RIGHT_JUSTIFIED;         // ADC结果调整,
  33   1                                         // ADC_LEFT_JUSTIFIED,ADC_RIGHT_JUSTIFIED
  34   1        ADC_Inilize(&ADC_InitStructure); // 初始化
  35   1        ADC_PowerControl(ENABLE);        // ADC电源开关, ENABLE或DISABLE
  36   1        NVIC_ADC_Init(DISABLE,
  37   1                      Priority_0); // 中断使能, ENABLE/DISABLE; 优先级(低到高)
  38   1                                   // Priority_0,Priority_1,Priority_2,Priority_3
  39   1      }
  40          
  41          void ntc_init(void) {
  42   1        gpio_config();
  43   1        ntc_config();
  44   1      }
  45          
  46          /**
  47           * 说明: 存储在MCU代码区的温度对照表，使用u16存储是为了节省内存(小数更占内
             -)
  48           * 使用:
  49           * 将要查询的温度放大100倍传入这个数组进行大小比较，找到与其最接近数的索
             -，用该索引减去55就能得到温度了
  50           */
  51          u16 code temp_table[] = {
  52          
C51 COMPILER V9.60.7.0   NTC                                                               06/26/2024 11:53:05 PAGE 2   

  53              58354, // -55
  54              55464, // -54
  55              52698, // -53
  56              50048, // -52
  57              47515, // -51
  58              45097, // -50
  59              42789, // -49
  60              40589, // -48
  61              38492, // -47
  62              36496, // -46
  63              34597, // -45
  64              32791, // -44
  65              31075, // -43
  66              29444, // -42
  67              27896, // -41
  68              26427, // -40
  69              25034, // -39
  70              23713, // -38
  71              22460, // -37
  72              21273, // -36
  73              20148, // -35
  74              19083, // -34
  75              18075, // -33
  76              17120, // -32
  77              16216, // -31
  78              15361, // -30
  79              14551, // -29
  80              13785, // -28
  81              13061, // -27
  82              12376, // -26
  83              11728, // -25
  84              11114, // -24
  85              10535, // -23
  86              9986,  // -22
  87              9468,  // -21
  88              8977,  // -20
  89              8513,  // -19
  90              8075,  // -18
  91              7660,  // -17
  92              7267,  // -16
  93              6896,  // -15
  94              6545,  // -14
  95              6212,  // -13
  96              5898,  // -12
  97              5601,  // -11
  98              5319,  // -10
  99              5053,  // -9
 100              4801,  // -8
 101              4562,  // -7
 102              4336,  // -6
 103              4122,  // -5
 104              3920,  // -4
 105              3728,  // -3
 106              3546,  // -2
 107              3374,  // -1
 108              3211,  // 0
 109              3057,  // 1
 110              2910,  // 2
 111              2771,  // 3
 112              2639,  // 4
 113              2515,  // 5
 114              2396,  // 6
C51 COMPILER V9.60.7.0   NTC                                                               06/26/2024 11:53:05 PAGE 3   

 115              2284,  // 7
 116              2177,  // 8
 117              2076,  // 9
 118              1978,  // 10
 119              1889,  // 11
 120              1802,  // 12
 121              1720,  // 13
 122              1642,  // 14
 123              1568,  // 15
 124              1497,  // 16
 125              1430,  // 17
 126              1366,  // 18
 127              1306,  // 19
 128              1248,  // 20
 129              1193,  // 21
 130              1141,  // 22
 131              1092,  // 23
 132              1044,  // 24
 133              1000,  // 25
 134              957,   // 26
 135              916,   // 27
 136              877,   // 28
 137              840,   // 29
 138              805,   // 30
 139              771,   // 31
 140              739,   // 32
 141              709,   // 33
 142              679,   // 34
 143              652,   // 35
 144              625,   // 36
 145              600,   // 37
 146              576,   // 38
 147              552,   // 39
 148              530,   // 40
 149              509,   // 41
 150              489,   // 42
 151              470,   // 43
 152              452,   // 44
 153              434,   // 45
 154              417,   // 46
 155              401,   // 47
 156              386,   // 48
 157              371,   // 49
 158              358,   // 50
 159              344,   // 51
 160              331,   // 52
 161              318,   // 53
 162              306,   // 54
 163              295,   // 55
 164              284,   // 56
 165              274,   // 57
 166              264,   // 58
 167              254,   // 59
 168              245,   // 60
 169              236,   // 61
 170              228,   // 62
 171              220,   // 63
 172              212,   // 64
 173              205,   // 65
 174              198,   // 66
 175              191,   // 67
 176              184,   // 68
C51 COMPILER V9.60.7.0   NTC                                                               06/26/2024 11:53:05 PAGE 4   

 177              178,   // 69
 178              172,   // 70
 179              166,   // 71
 180              160,   // 72
 181              155,   // 73
 182              150,   // 74
 183              145,   // 75
 184              140,   // 76
 185              135,   // 77
 186              131,   // 78
 187              126,   // 79
 188              122,   // 80
 189              118,   // 81
 190              115,   // 82
 191              111,   // 83
 192              107,   // 84
 193              104,   // 85
 194              101,   // 86
 195              97,    // 87
 196              94,    // 88
 197              91,    // 89
 198              89,    // 90
 199              86,    // 91
 200              83,    // 92
 201              81,    // 93
 202              78,    // 94
 203              76,    // 95
 204              74,    // 96
 205              71,    // 97
 206              69,    // 98
 207              67,    // 99
 208              65,    // 100
 209              63,    // 101
 210              61,    // 102
 211              60,    // 103
 212              58,    // 104
 213              56,    // 105
 214              55,    // 106
 215              53,    // 107
 216              52,    // 108
 217              50,    // 109
 218              49,    // 110
 219              47,    // 111
 220              46,    // 112
 221              45,    // 113
 222              43,    // 114
 223              42,    // 115
 224              41,    // 116
 225              40,    // 117
 226              39,    // 118
 227              38,    // 119
 228              37,    // 120
 229              36,    // 121
 230              35,    // 122
 231              34,    // 123
 232              33,    // 124
 233              32,    // 125
 234          };
 235          
 236          /**
 237           * @parm search_ntc 要查询对应温度的阻值(需乘100传入)
 238           * @return 要查询的温度
C51 COMPILER V9.60.7.0   NTC                                                               06/26/2024 11:53:05 PAGE 5   

 239           */
 240          int NTC_search_temperature(float search_ntc) {
 241   1        int i;
 242   1        int min_index = 0; // 最小索引
 243   1        float diff;        // 温度值比较的临时索引
 244   1      
 245   1        // 计算温度对照表数组的长度
 246   1        int temp_size = sizeof(temp_table) / sizeof(temp_table[min_index]);
 247   1        // 记录最小温度值
 248   1        float min_diff = ABS(search_ntc - temp_table[min_index]);
 249   1        // 遍历温度数组，计算与其接近值的最小索引
 250   1        for (i = 0; i < temp_size; i++) {
 251   2          diff = ABS(search_ntc - temp_table[i]);
 252   2          // 如果当前遍历值小于定义的最小温度值，那么就让他成为最小值
 253   2          if (diff < min_diff) {
 254   3            min_diff = diff;
 255   3            min_index = i;
 256   3          }
 257   2        }
 258   1      
 259   1        return (min_index - 55);
 260   1      }
 261          
 262          int NTC_get_temperature(void) {
 263   1        u16 adc_value; // ADC信号
 264   1        float v_ntc;   // NTC的电压
 265   1        float R_ntc;   // NTC的阻值
 266   1        int temp;      // NTC阻值所对应的温度
 267   1      
 268   1        adc_value = Get_ADCResult(NTC_ACD_CH); // 从ADC12通道获取ADC值，对应P04
 269   1        // 计算热敏电阻的电压
 270   1        v_ntc = adc_value * VOL_REF / 4096;
 271   1        // 根据电路设计及欧姆定理计算热敏电阻的阻值
 272   1        R_ntc = (v_ntc * R20) / (5 - v_ntc);
 273   1        // 查询阻值对应的温度值
 274   1        temp = NTC_search_temperature(R_ntc * 100);
 275   1        printf("Temp2: %dC", temp);
 276   1        return temp;
 277   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    649    ----
   CONSTANT SIZE    =    373    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      35
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
