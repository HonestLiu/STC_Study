C51 COMPILER V9.60.7.0   MAIN                                                              06/26/2024 10:08:24 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\AppData\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listi
                    -ngs\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "ADC.h"
   2          #include "Config.h"
   3          #include "Delay.h"
   4          #include "GPIO.h"
   5          #include "NVIC.h"
   6          #include "Switch.h"
   7          #include "UART.h"
   8          #include <stdio.h>
   9          /**
  10           * @note éœ€æ±‚: æµ‹é‡P04ç«¯å£è¿æ¥çš„çƒ­æ•ç”µé˜»çš„é˜»å€¼
  11           */
  12          
  13          #define R20 10
  14          
  15          /* åˆå§‹åŒ–GPIO P04 ä¸ºæµ®ç©ºè¾“å…¥æ¨¡å¼ï¼Œå³ADCå¼•è„š */
  16          void Gpio_Config(void) {
  17   1        GPIO_InitTypeDef gpio_config_struct;
  18   1        gpio_config_struct.Mode = GPIO_HighZ; // æµ®ç©ºè¾“å…¥
  19   1        gpio_config_struct.Pin = GPIO_Pin_4;  // å¼•è„š4
  20   1        GPIO_Inilize(GPIO_P0, &gpio_config_struct);
  21   1      }
  22          
  23          /* åˆå§‹åŒ–Uart */
  24          void UART_config(void) {
  25   1        // >>> è®°å¾—æ·»åŠ  NVIC.c, UART.c, UART_Isr.c <<<
  26   1        COMx_InitDefine COMx_InitStructure; // ç»“æ„å®šä¹‰
  27   1      
  28   1        COMx_InitStructure.UART_Mode =
  29   1            UART_8bit_BRTx; // æ¨¡å¼,
  30   1                            // UART_ShiftRight,UART_8bit_BRTx,UART_9bit,UART_9bit_BRTx
  31   1      
  32   1        COMx_InitStructure.UART_BRT_Use =
  33   1            BRT_Timer1; // é€‰æ‹©æ³¢ç‰¹ç‡å‘ç”Ÿå™¨, BRT_Timer1, BRT_Timer2 (æ³¨æ„:
  34   1                        // ä¸²å£2å›ºå®šä½¿ç”¨BRT_Timer2)
  35   1      
  36   1        COMx_InitStructure.UART_BaudRate = 115200ul; // æ³¢ç‰¹ç‡, ä¸€èˆ¬ 110 ~ 115200
  37   1        COMx_InitStructure.UART_RxEnable = ENABLE; // æ¥æ”¶å…è®¸,   ENABLEæˆ–DISABLE
  38   1        COMx_InitStructure.BaudRateDouble = DISABLE; // æ³¢ç‰¹ç‡åŠ å€, ENABLEæˆ–DISABLE
  39   1      
  40   1        UART_Configuration(
  41   1            UART1, &COMx_InitStructure); // åˆå§‹åŒ–ä¸²å£1 UART1,UART2,UART3,UART4
  42   1      
  43   1        NVIC_UART1_Init(ENABLE,
  44   1                        Priority_1); // ä¸­æ–­ä½¿èƒ½, ENABLE/DISABLE; ä¼˜å…ˆçº§(ä½åˆ°é«˜)
  45   1                                     // Priority_0,Priority_1,Priority_2,Priority_3
  46   1        UART1_SW(
  47   1            UART1_SW_P30_P31); // å¼•è„šé€‰æ‹©,
  48   1                               // UART1_SW_P30_P31,UART1_SW_P36_P37,UART1_SW_P16_P17,UART1_SW_P43_P44
  49   1      }
  50          
  51          /* åˆå§‹åŒ–ADC */
  52          void ADC_config(void) {
  53   1        ADC_InitTypeDef ADC_InitStructure; // ç»“æ„å®šä¹‰
  54   1      
C51 COMPILER V9.60.7.0   MAIN                                                              06/26/2024 10:08:24 PAGE 2   

  55   1        ADC_InitStructure.ADC_SMPduty = 31; // ADC æ¨¡æ‹Ÿä¿¡å·é‡‡æ ·æ—¶é—´æ§åˆ¶, 0~31ï¼ˆæ³¨æ„ï¼š
  56   1                                            // SMPDUTY ä¸€å®šä¸èƒ½è®¾ç½®å°äº 10ï¼‰
  57   1        ADC_InitStructure.ADC_CsSetup = 0; // ADC é€šé“é€‰æ‹©æ—¶é—´æ§åˆ¶ 0(é»˜è®¤),1
  58   1        ADC_InitStructure.ADC_CsHold = 1; // ADC é€šé“é€‰æ‹©ä¿æŒæ—¶é—´æ§åˆ¶ 0,1(é»˜è®¤),2,3
  59   1        ADC_InitStructure.ADC_Speed =
  60   1            ADC_SPEED_2X1T; // è®¾ç½® ADC å·¥ä½œæ—¶é’Ÿé¢‘ç‡  ADC_SPEED_2X1T~ADC_SPEED_2X16T
  61   1        ADC_InitStructure.ADC_AdjResult =
  62   1            ADC_RIGHT_JUSTIFIED;         // ADCç»“æœè°ƒæ•´,
  63   1                                         // ADC_LEFT_JUSTIFIED,ADC_RIGHT_JUSTIFIED
  64   1        ADC_Inilize(&ADC_InitStructure); // åˆå§‹åŒ–
  65   1        ADC_PowerControl(ENABLE);        // ADCç”µæºå¼€å…³, ENABLEæˆ–DISABLE
  66   1        NVIC_ADC_Init(DISABLE,
  67   1                      Priority_0); // ä¸­æ–­ä½¿èƒ½, ENABLE/DISABLE; ä¼˜å…ˆçº§(ä½åˆ°é«˜)
  68   1                                   // Priority_0,Priority_1,Priority_2,Priority_3
  69   1      }
  70          
  71          /**
  72           * è¯´æ˜: å­˜å‚¨åœ¨MCUä»£ç åŒºçš„æ¸©åº¦å¯¹ç…§è¡¨ï¼Œä½¿ç”¨u16å­˜å‚¨æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜(å°æ•°æ›´å å†…å
             -­˜)
  73           * ä½¿ç”¨:
  74           * å°†è¦æŸ¥è¯¢çš„æ¸©åº¦æ”¾å¤§100å€ä¼ å…¥è¿™ä¸ªæ•°ç»„è¿›è¡Œå¤§å°æ¯”è¾ƒï¼Œæ‰¾åˆ°ä¸å…¶æœ€æ¥è¿‘æ•°çš„ç´¢å
             -¼•ï¼Œç”¨è¯¥ç´¢å¼•å‡å»55å°±èƒ½å¾—åˆ°æ¸©åº¦äº†
  75           */
  76          u16 code temp_table[] = {
  77              58354, // -55
  78              55464, // -54
  79              52698, // -53
  80              50048, // -52
  81              47515, // -51
  82              45097, // -50
  83              42789, // -49
  84              40589, // -48
  85              38492, // -47
  86              36496, // -46
  87              34597, // -45
  88              32791, // -44
  89              31075, // -43
  90              29444, // -42
  91              27896, // -41
  92              26427, // -40
  93              25034, // -39
  94              23713, // -38
  95              22460, // -37
  96              21273, // -36
  97              20148, // -35
  98              19083, // -34
  99              18075, // -33
 100              17120, // -32
 101              16216, // -31
 102              15361, // -30
 103              14551, // -29
 104              13785, // -28
 105              13061, // -27
 106              12376, // -26
 107              11728, // -25
 108              11114, // -24
 109              10535, // -23
 110              9986,  // -22
 111              9468,  // -21
 112              8977,  // -20
 113              8513,  // -19
 114              8075,  // -18
C51 COMPILER V9.60.7.0   MAIN                                                              06/26/2024 10:08:24 PAGE 3   

 115              7660,  // -17
 116              7267,  // -16
 117              6896,  // -15
 118              6545,  // -14
 119              6212,  // -13
 120              5898,  // -12
 121              5601,  // -11
 122              5319,  // -10
 123              5053,  // -9
 124              4801,  // -8
 125              4562,  // -7
 126              4336,  // -6
 127              4122,  // -5
 128              3920,  // -4
 129              3728,  // -3
 130              3546,  // -2
 131              3374,  // -1
 132              3211,  // 0
 133              3057,  // 1
 134              2910,  // 2
 135              2771,  // 3
 136              2639,  // 4
 137              2515,  // 5
 138              2396,  // 6
 139              2284,  // 7
 140              2177,  // 8
 141              2076,  // 9
 142              1978,  // 10
 143              1889,  // 11
 144              1802,  // 12
 145              1720,  // 13
 146              1642,  // 14
 147              1568,  // 15
 148              1497,  // 16
 149              1430,  // 17
 150              1366,  // 18
 151              1306,  // 19
 152              1248,  // 20
 153              1193,  // 21
 154              1141,  // 22
 155              1092,  // 23
 156              1044,  // 24
 157              1000,  // 25
 158              957,   // 26
 159              916,   // 27
 160              877,   // 28
 161              840,   // 29
 162              805,   // 30
 163              771,   // 31
 164              739,   // 32
 165              709,   // 33
 166              679,   // 34
 167              652,   // 35
 168              625,   // 36
 169              600,   // 37
 170              576,   // 38
 171              552,   // 39
 172              530,   // 40
 173              509,   // 41
 174              489,   // 42
 175              470,   // 43
 176              452,   // 44
C51 COMPILER V9.60.7.0   MAIN                                                              06/26/2024 10:08:24 PAGE 4   

 177              434,   // 45
 178              417,   // 46
 179              401,   // 47
 180              386,   // 48
 181              371,   // 49
 182              358,   // 50
 183              344,   // 51
 184              331,   // 52
 185              318,   // 53
 186              306,   // 54
 187              295,   // 55
 188              284,   // 56
 189              274,   // 57
 190              264,   // 58
 191              254,   // 59
 192              245,   // 60
 193              236,   // 61
 194              228,   // 62
 195              220,   // 63
 196              212,   // 64
 197              205,   // 65
 198              198,   // 66
 199              191,   // 67
 200              184,   // 68
 201              178,   // 69
 202              172,   // 70
 203              166,   // 71
 204              160,   // 72
 205              155,   // 73
 206              150,   // 74
 207              145,   // 75
 208              140,   // 76
 209              135,   // 77
 210              131,   // 78
 211              126,   // 79
 212              122,   // 80
 213              118,   // 81
 214              115,   // 82
 215              111,   // 83
 216              107,   // 84
 217              104,   // 85
 218              101,   // 86
 219              97,    // 87
 220              94,    // 88
 221              91,    // 89
 222              89,    // 90
 223              86,    // 91
 224              83,    // 92
 225              81,    // 93
 226              78,    // 94
 227              76,    // 95
 228              74,    // 96
 229              71,    // 97
 230              69,    // 98
 231              67,    // 99
 232              65,    // 100
 233              63,    // 101
 234              61,    // 102
 235              60,    // 103
 236              58,    // 104
 237              56,    // 105
 238              55,    // 106
C51 COMPILER V9.60.7.0   MAIN                                                              06/26/2024 10:08:24 PAGE 5   

 239              53,    // 107
 240              52,    // 108
 241              50,    // 109
 242              49,    // 110
 243              47,    // 111
 244              46,    // 112
 245              45,    // 113
 246              43,    // 114
 247              42,    // 115
 248              41,    // 116
 249              40,    // 117
 250              39,    // 118
 251              38,    // 119
 252              37,    // 120
 253              36,    // 121
 254              35,    // 122
 255              34,    // 123
 256              33,    // 124
 257              32,    // 125
 258          };
 259          
 260          #define ABS(x) x > 0 ? (x) : -(x)
 261          
 262          /**
 263           *
 264           */
 265          int NTC_get_temperature(float search_ntc) {
 266   1        int i;
 267   1        int min_index = 0; // æœ€å°ç´¢å¼•
 268   1        float diff;        // æ¸©åº¦å€¼æ¯”è¾ƒçš„ä¸´æ—¶ç´¢å¼•
 269   1      
 270   1        // è®¡ç®—æ¸©åº¦å¯¹ç…§è¡¨æ•°ç»„çš„é•¿åº¦
 271   1        int temp_size = sizeof(temp_table) / sizeof(temp_table[min_index]);
 272   1        // è®°å½•æœ€å°æ¸©åº¦å€¼
 273   1        float min_diff = ABS(search_ntc - temp_table[0]);
 274   1        // éå†æ¸©åº¦æ•°ç»„ï¼Œè®¡ç®—ä¸å…¶æ¥è¿‘å€¼çš„æœ€å°ç´¢å¼•
 275   1        for (i = 0; i < temp_size; i++) {
 276   2          diff = ABS(search_ntc - temp_table[i]);
 277   2          // å¦‚æœå½“å‰éå†å€¼å°äºå®šä¹‰çš„æœ€å°æ¸©åº¦å€¼ï¼Œé‚£ä¹ˆå°±è®©ä»–æˆä¸ºæœ€å°å€¼
 278   2          if (diff < min_diff) {
 279   3            min_diff = diff;
 280   3            min_index = i;
 281   3          }
 282   2        }
 283   1      
 284   1        return (min_index - 55);
 285   1      }
 286          
 287          int main(void) {
 288   1        u16 adc_value;
 289   1        float v_ntc;
 290   1        float R_ntc;
 291   1        int temp;
 292   1      
 293   1        Gpio_Config();
 294   1        UART_config();
 295   1        ADC_config();
 296   1      
 297   1        EA = 1; // å¼€å¯å…¨å±€ä¸­æ–­
 298   1      
 299   1        while (1) {
 300   2          adc_value = Get_ADCResult(ADC_CH12); // ä»ADC12é€šé“è·å–ADCå€¼ï¼Œå¯¹åº”P04
C51 COMPILER V9.60.7.0   MAIN                                                              06/26/2024 10:08:24 PAGE 6   

 301   2          // è®¡ç®—çƒ­æ•ç”µé˜»çš„ç”µå‹
 302   2          v_ntc = adc_value * 2.5 / 4096;
 303   2          // æ ¹æ®ç”µè·¯è®¾è®¡åŠæ¬§å§†å®šç†è®¡ç®—çƒ­æ•ç”µé˜»çš„é˜»å€¼
 304   2          R_ntc = (v_ntc * R20) / (5 - v_ntc);
 305   2          // æŸ¥è¯¢é˜»å€¼å¯¹åº”çš„æ¸©åº¦å€¼
 306   2          temp = NTC_get_temperature(R_ntc * 100);
 307   2          // æ‰“å°é˜»å€¼
 308   2          printf("R_ntc: %.2fR Temp: %dC", R_ntc, temp);
 309   2      
 310   2          delay_ms(250);
 311   2          delay_ms(250);
 312   2          delay_ms(250);
 313   2          delay_ms(250);
 314   2        }
 315   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    684    ----
   CONSTANT SIZE    =    385    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      46
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
